# üí≥ Syst√®me de Cr√©dits et Parrainage - Sp√©cifications Compl√®tes

## üìã Vue d'Ensemble

Le syst√®me de cr√©dits permet aux prestataires (th√©rapeutes et salons) de maintenir leur visibilit√© sur la plateforme. Les cr√©dits sont consomm√©s en fonction des interactions des clients avec leur profil.

---

## üí∞ Attribution des Cr√©dits

### Cr√©dits Initiaux
- **20 cr√©dits gratuits** √† l'inscription et validation du compte prestataire

### Cr√©dits Mensuels
- **+5 cr√©dits automatiques** chaque mois (m√™me jour que l'inscription)
- Attribution via cron job le 1er de chaque mois √† 00:00

### R√®gles G√©n√©rales
- ‚úÖ Les cr√©dits **n'expirent jamais**
- ‚ùå Les cr√©dits **n√©gatifs ne sont pas autoris√©s**
- ‚úÖ Pas de diff√©rence entre th√©rapeutes et salons

---

## üìä Co√ªt des Interactions

| Interaction | Co√ªt (cr√©dits) | D√©clencheur | Notes |
|-------------|----------------|-------------|-------|
| **Visite de profil** | 0.1 | Client consulte le profil | Premi√®re visite uniquement |
| **Chat pr√©-commande** | 1.0 | Client envoie 1er message | Avant toute r√©servation |
| **Chat post-commande** | 0.0 | Client envoie message | Apr√®s une r√©servation (gratuit) |
| **R√©servation confirm√©e** | 3.0 | Statut passe √† CONFIRMED | Consomme le plus |
| **Avis laiss√©** | 0.5 | Client publie un avis | Feedback pr√©cieux |
| **Favori ajout√©** | 0.3 | Client ajoute aux favoris | Int√©r√™t marqu√© |

### R√®gles Sp√©ciales

#### R√©servations en cours
- Si un prestataire a **0 cr√©dit** pendant une r√©servation **d√©j√† confirm√©e**, la r√©servation continue normalement
- Les nouvelles r√©servations sont **bloqu√©es** si cr√©dits = 0

#### Annulation de r√©servation
- **Remboursement de 60%** des cr√©dits d√©bit√©s
- **Arrondi inf√©rieur** (ex: 3 cr√©dits ‚Üí 1.8 ‚Üí **1 cr√©dit** rembours√©)
- Remboursement uniquement si annulation avant la date pr√©vue

---

## üõí Packs de Cr√©dits

### Tarification

| Pack | Cr√©dits | Prix (FCFA) | Prix/cr√©dit | √âconomie |
|------|---------|-------------|-------------|----------|
| **Light** | 20 | 2,000 | 100 | 0% (prix de base) |
| **Starter** | 50 | 4,500 | 90 | 10% |
| **Pro** | 100 | 8,000 | 80 | 20% |
| **Business** | 250 | 18,000 | 72 | 28% |
| **Premium** | 500 | 35,000 | 70 | 30% |

### M√©thode de Paiement

**Flutterwave** - Int√©gration compl√®te
- üí≥ Cartes bancaires (Visa, Mastercard)
- üì± Mobile Money (Orange Money, MTN Money)
- üè¶ Virements bancaires
- üåç Support multi-devises (FCFA prioritaire)

#### Configuration Flutterwave
```typescript
// Variables d'environnement
FLUTTERWAVE_PUBLIC_KEY=FLWPUBK-xxxxx
FLUTTERWAVE_SECRET_KEY=FLWSECK-xxxxx
FLUTTERWAVE_ENCRYPTION_KEY=FLWSECK-xxxxx
FLUTTERWAVE_WEBHOOK_SECRET=xxxxx
```

---

## üëÅÔ∏è Syst√®me de Visibilit√©

### R√®gle Principale
- **Cr√©dits > 0** : Profil **visible** dans les r√©sultats de recherche
- **Cr√©dits = 0** : Profil **compl√®tement cach√©** (non visible du tout)

### Ordre d'Affichage (sans boost)
1. Providers avec cr√©dits > 0
2. Tri par note (rating) d√©croissant
3. Tri par nombre d'avis

---

## üöÄ Boost de Positionnement

### Principe
Les prestataires peuvent acheter une position dans le **Top 5** des r√©sultats de recherche pour leur zone g√©ographique (ville + quartier).

### Tarifs Fixes (7 jours)

| Position | Cr√©dits/7 jours | Visibilit√© |
|----------|-----------------|------------|
| **#1** | 60 | Maximum |
| **#2** | 50 | Tr√®s haute |
| **#3** | 40 | Haute |
| **#4** | 30 | Bonne |
| **#5** | 20 | Moyenne |

### Syst√®me Hybride : Prix Fixe vs Ench√®res

#### Prix Fixe (‚â§ 4 demandes)
- Si **4 demandes ou moins** pour une position dans la m√™me zone : **prix fixe**
- Attribution : premier arriv√©, premier servi
- Paiement imm√©diat

#### Ench√®res (> 4 demandes)
- Si **plus de 4 demandes** pour une position dans la m√™me zone : **syst√®me d'ench√®res**
- Ench√®re minimale = prix fixe de la position
- Dur√©e d'ench√®res : **24 heures**
- Attribution au **plus offrant**
- Notification aux participants

#### D√©finition de "Zone"
- **Ville** + **Quartier** du prestataire
- Exemple : "Yaound√© - Bastos" est une zone distincte de "Yaound√© - Melen"

### Affichage des Positions Boost√©es
- Badge **"Top 1"**, **"Top 2"**, etc. sur la carte du prestataire
- Ic√¥ne sp√©ciale (‚≠ê ou üî•)
- Couleur distinctive dans les r√©sultats

---

## üéÅ Syst√®me de Parrainage

### Principe
Les prestataires peuvent inviter d'autres prestataires √† rejoindre la plateforme via un code de parrainage unique.

### R√©compenses

#### Pour le Filleul (invit√©)
- **+5 cr√©dits bonus** √† l'inscription valid√©e
- **Total : 25 cr√©dits** au d√©part (20 de base + 5 bonus)

#### Pour le Parrain (qui invite)
| √âv√©nement | Bonus |
|-----------|-------|
| Filleul inscrit et valid√© | +10 cr√©dits |
| Premi√®re r√©servation du filleul | +5 cr√©dits |
| **Total possible** | **+15 cr√©dits** |

### R√®gles et Limites

#### Limite de Parrainage
- **Maximum 10 parrainages par mois** par prestataire
- Compteur remis √† z√©ro le 1er de chaque mois
- Protection contre les abus

#### Code de Parrainage
- Format : `KMER-XXXXX` (8 caract√®res alphanum√©riques)
- Unique par prestataire
- G√©n√©r√© automatiquement √† la validation du compte
- Partageable via lien ou code

#### Validation
1. Filleul entre le code lors de l'inscription
2. Compte filleul doit √™tre **valid√©** par admin
3. Attribution des bonus au parrain apr√®s validation
4. Bonus suppl√©mentaire apr√®s 1√®re r√©servation confirm√©e du filleul

### Suivi et Statistiques
- Nombre de filleuls actifs
- Cr√©dits gagn√©s via parrainage
- Historique des parrainages
- Statut de chaque filleul (en attente, valid√©, actif)

---

## üîî Notifications et Alertes

### Alertes Automatiques

#### Cr√©dits Faibles
- **Seuil : < 5 cr√©dits**
- Notification push + email
- Fr√©quence : quotidienne (10h00)
- Message : "Vos cr√©dits sont faibles. Rechargez pour rester visible !"

#### Cr√©dits √âpuis√©s
- **Seuil : = 0 cr√©dit**
- Notification push + email imm√©diate
- Message : "Votre profil est maintenant cach√©. Achetez des cr√©dits pour redevenir visible."

#### Boost Expir√©
- **24h avant expiration** du boost
- Notification push
- Message : "Votre boost position #X expire dans 24h. Renouvelez maintenant !"

#### Parrainage Valid√©
- Notification au parrain quand filleul est valid√©
- Notification au parrain √† la 1√®re r√©servation du filleul

---

## üóÑÔ∏è Architecture Base de Donn√©es

### Tables Principales

#### 1. `provider_credits`
```sql
CREATE TABLE provider_credits (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  provider_id UUID NOT NULL,
  provider_type VARCHAR(20) NOT NULL, -- 'therapist' | 'salon'
  balance DECIMAL(10,2) DEFAULT 20.00,
  total_earned DECIMAL(10,2) DEFAULT 20.00,
  total_spent DECIMAL(10,2) DEFAULT 0.00,
  monthly_credits_last_given TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(provider_id, provider_type)
);
```

#### 2. `credit_transactions`
```sql
CREATE TABLE credit_transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  provider_id UUID NOT NULL,
  provider_type VARCHAR(20) NOT NULL,
  amount DECIMAL(10,2) NOT NULL, -- + gain, - d√©bit
  transaction_type VARCHAR(50) NOT NULL,
  -- Types: 'initial_bonus', 'monthly_bonus', 'purchase', 'profile_view', 
  --        'chat_pre_booking', 'booking_confirmed', 'review', 'favorite',
  --        'referral_signup', 'referral_first_booking', 'boost_position',
  --        'refund_cancellation'
  reference_id UUID, -- booking_id, purchase_id, referral_id, etc.
  balance_before DECIMAL(10,2) NOT NULL,
  balance_after DECIMAL(10,2) NOT NULL,
  metadata JSONB, -- Donn√©es suppl√©mentaires
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_credit_transactions_provider ON credit_transactions(provider_id, provider_type);
CREATE INDEX idx_credit_transactions_type ON credit_transactions(transaction_type);
CREATE INDEX idx_credit_transactions_date ON credit_transactions(created_at);
```

#### 3. `interaction_costs`
```sql
CREATE TABLE interaction_costs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  interaction_type VARCHAR(50) UNIQUE NOT NULL,
  cost DECIMAL(10,2) NOT NULL,
  description TEXT,
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Donn√©es initiales
INSERT INTO interaction_costs (interaction_type, cost, description) VALUES
  ('profile_view', 0.1, 'Visite du profil prestataire'),
  ('chat_pre_booking', 1.0, 'Chat avant r√©servation'),
  ('booking_confirmed', 3.0, 'R√©servation confirm√©e'),
  ('review_created', 0.5, 'Avis client publi√©'),
  ('favorite_added', 0.3, 'Ajout aux favoris');
```

#### 4. `credit_packs`
```sql
CREATE TABLE credit_packs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100) NOT NULL,
  credits INTEGER NOT NULL,
  price_fcfa INTEGER NOT NULL,
  discount_percentage INTEGER DEFAULT 0,
  display_order INTEGER DEFAULT 0,
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Donn√©es initiales
INSERT INTO credit_packs (name, credits, price_fcfa, discount_percentage, display_order) VALUES
  ('Light', 20, 2000, 0, 1),
  ('Starter', 50, 4500, 10, 2),
  ('Pro', 100, 8000, 20, 3),
  ('Business', 250, 18000, 28, 4),
  ('Premium', 500, 35000, 30, 5);
```

#### 5. `credit_purchases`
```sql
CREATE TABLE credit_purchases (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  provider_id UUID NOT NULL,
  provider_type VARCHAR(20) NOT NULL,
  pack_id UUID REFERENCES credit_packs(id),
  credits_amount INTEGER NOT NULL,
  price_paid INTEGER NOT NULL,
  payment_method VARCHAR(50), -- 'card', 'mobile_money', 'bank_transfer'
  payment_provider VARCHAR(50) DEFAULT 'flutterwave',
  flutterwave_transaction_id VARCHAR(255),
  flutterwave_tx_ref VARCHAR(255) UNIQUE,
  payment_status VARCHAR(50) DEFAULT 'pending',
  -- Status: 'pending', 'processing', 'successful', 'failed', 'cancelled'
  payment_data JSONB, -- R√©ponse compl√®te Flutterwave
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);

CREATE INDEX idx_credit_purchases_provider ON credit_purchases(provider_id, provider_type);
CREATE INDEX idx_credit_purchases_status ON credit_purchases(payment_status);
```

#### 6. `referrals`
```sql
CREATE TABLE referrals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  referrer_id UUID NOT NULL, -- Parrain
  referrer_type VARCHAR(20) NOT NULL,
  referee_id UUID, -- Filleul (NULL si pas encore inscrit)
  referee_type VARCHAR(20),
  referral_code VARCHAR(20) UNIQUE NOT NULL,
  status VARCHAR(50) DEFAULT 'pending',
  -- Status: 'pending', 'signup_completed', 'validated', 'first_booking_done'
  credits_earned DECIMAL(10,2) DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  signup_completed_at TIMESTAMP,
  validated_at TIMESTAMP,
  first_booking_at TIMESTAMP
);

CREATE INDEX idx_referrals_code ON referrals(referral_code);
CREATE INDEX idx_referrals_referrer ON referrals(referrer_id, referrer_type);
CREATE INDEX idx_referrals_referee ON referrals(referee_id, referee_type);
```

#### 7. `referral_monthly_limits`
```sql
CREATE TABLE referral_monthly_limits (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  provider_id UUID NOT NULL,
  provider_type VARCHAR(20) NOT NULL,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL, -- 1-12
  referral_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(provider_id, provider_type, year, month)
);
```

#### 8. `position_boosts`
```sql
CREATE TABLE position_boosts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  provider_id UUID NOT NULL,
  provider_type VARCHAR(20) NOT NULL,
  position INTEGER NOT NULL CHECK (position BETWEEN 1 AND 5),
  city VARCHAR(100) NOT NULL,
  district VARCHAR(100) NOT NULL, -- Quartier
  duration_days INTEGER DEFAULT 7,
  credits_cost DECIMAL(10,2) NOT NULL,
  start_date TIMESTAMP NOT NULL,
  end_date TIMESTAMP NOT NULL,
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_position_boosts_zone ON position_boosts(city, district, position, active);
CREATE INDEX idx_position_boosts_provider ON position_boosts(provider_id, provider_type);
CREATE INDEX idx_position_boosts_dates ON position_boosts(start_date, end_date);
```

#### 9. `position_boost_bids`
```sql
CREATE TABLE position_boost_bids (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  provider_id UUID NOT NULL,
  provider_type VARCHAR(20) NOT NULL,
  position INTEGER NOT NULL CHECK (position BETWEEN 1 AND 5),
  city VARCHAR(100) NOT NULL,
  district VARCHAR(100) NOT NULL,
  bid_amount DECIMAL(10,2) NOT NULL, -- En cr√©dits
  auction_end_date TIMESTAMP NOT NULL,
  status VARCHAR(50) DEFAULT 'active',
  -- Status: 'active', 'won', 'lost', 'cancelled'
  created_at TIMESTAMP DEFAULT NOW(),
  resolved_at TIMESTAMP
);

CREATE INDEX idx_boost_bids_zone ON position_boost_bids(city, district, position, status);
CREATE INDEX idx_boost_bids_provider ON position_boost_bids(provider_id, provider_type);
```

---

## üîß Backend - Services NestJS

### Module Structure

```
src/
‚îú‚îÄ‚îÄ credits/
‚îÇ   ‚îú‚îÄ‚îÄ credits.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ credits.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ transactions.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ interaction-tracking.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ monthly-credits.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ visibility.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ credits.controller.ts
‚îú‚îÄ‚îÄ payments/
‚îÇ   ‚îú‚îÄ‚îÄ payments.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ flutterwave.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ purchase.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ webhook.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ payments.controller.ts
‚îú‚îÄ‚îÄ referrals/
‚îÇ   ‚îú‚îÄ‚îÄ referrals.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ referrals.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ referral-code.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ referrals.controller.ts
‚îî‚îÄ‚îÄ boosts/
    ‚îú‚îÄ‚îÄ boosts.module.ts
    ‚îú‚îÄ‚îÄ position-boost.service.ts
    ‚îú‚îÄ‚îÄ bid.service.ts
    ‚îú‚îÄ‚îÄ zone-analysis.service.ts
    ‚îî‚îÄ‚îÄ boosts.controller.ts
```

### Endpoints API Principaux

#### Cr√©dits
```typescript
GET    /api/v1/credits/balance
GET    /api/v1/credits/transactions?page=1&limit=20
GET    /api/v1/credits/stats
POST   /api/v1/credits/debit (admin only)
POST   /api/v1/credits/credit (admin only)
```

#### Packs & Achats
```typescript
GET    /api/v1/credits/packs
POST   /api/v1/credits/purchase
GET    /api/v1/credits/purchases/history
GET    /api/v1/credits/purchases/:id
```

#### Parrainage
```typescript
GET    /api/v1/referrals/my-code
POST   /api/v1/referrals/validate-code
GET    /api/v1/referrals/stats
GET    /api/v1/referrals/history
GET    /api/v1/referrals/monthly-limit
```

#### Boost de Position
```typescript
GET    /api/v1/boosts/available-positions?city=Yaound√©&district=Bastos
POST   /api/v1/boosts/purchase
POST   /api/v1/boosts/bid
GET    /api/v1/boosts/my-active
GET    /api/v1/boosts/auction-status?position=1&city=Yaound√©&district=Bastos
```

#### Webhooks Flutterwave
```typescript
POST   /api/v1/payments/webhook/flutterwave
```

---

## ‚öôÔ∏è Automatisations (Cron Jobs)

### 1. Attribution Mensuelle de Cr√©dits
```typescript
@Cron('0 0 1 * *') // 1er de chaque mois √† 00:00
async giveMonthlyCredits() {
  // Pour chaque prestataire actif
  // +5 cr√©dits
  // Cr√©er transaction 'monthly_bonus'
  // Mettre √† jour monthly_credits_last_given
}
```

### 2. Traitement des Ench√®res
```typescript
@Cron('0 * * * *') // Toutes les heures
async processBoostBids() {
  // R√©cup√©rer ench√®res termin√©es (auction_end_date < now)
  // D√©terminer gagnant (bid_amount max)
  // Cr√©er position_boost pour le gagnant
  // D√©biter cr√©dits
  // Notifier participants (gagnant + perdants)
  // Marquer ench√®res comme 'won' ou 'lost'
}
```

### 3. Nettoyage Boosts Expir√©s
```typescript
@Cron('0 2 * * *') // Tous les jours √† 02:00
async cleanExpiredBoosts() {
  // D√©sactiver boosts avec end_date < now
  // Notifier prestataires
}
```

### 4. Alertes Cr√©dits Faibles
```typescript
@Cron('0 10 * * *') // Tous les jours √† 10:00
async sendLowCreditAlerts() {
  // R√©cup√©rer providers avec balance < 5
  // Envoyer notification push + email
  // Logger l'alerte
}
```

### 5. Rappel Boost Expiration
```typescript
@Cron('0 12 * * *') // Tous les jours √† 12:00
async sendBoostExpirationReminders() {
  // R√©cup√©rer boosts expirant dans 24h
  // Notifier prestataires
}
```

---

## üéØ Event Listeners (D√©bit Automatique)

### Configuration
```typescript
// Dans chaque service concern√©
import { EventEmitter2 } from '@nestjs/event-emitter';

constructor(
  private eventEmitter: EventEmitter2,
  private interactionTrackingService: InteractionTrackingService
) {}
```

### √âv√©nements √† √âcouter

#### 1. Visite de Profil
```typescript
@OnEvent('profile.viewed')
async handleProfileView(payload: {
  providerId: string;
  providerType: 'therapist' | 'salon';
  userId: string;
}) {
  await this.interactionTrackingService.debitCredits(
    payload.providerId,
    payload.providerType,
    'profile_view',
    payload.userId
  );
}
```

#### 2. Chat Initi√©
```typescript
@OnEvent('chat.started')
async handleChatStarted(payload: {
  providerId: string;
  providerType: 'therapist' | 'salon';
  userId: string;
  chatId: string;
  isPreBooking: boolean; // true si aucune r√©servation confirm√©e
}) {
  if (payload.isPreBooking) {
    await this.interactionTrackingService.debitCredits(
      payload.providerId,
      payload.providerType,
      'chat_pre_booking',
      payload.chatId
    );
  }
}
```

#### 3. R√©servation Confirm√©e
```typescript
@OnEvent('booking.confirmed')
async handleBookingConfirmed(payload: {
  providerId: string;
  providerType: 'therapist' | 'salon';
  bookingId: string;
}) {
  await this.interactionTrackingService.debitCredits(
    payload.providerId,
    payload.providerType,
    'booking_confirmed',
    payload.bookingId
  );
}
```

#### 4. Avis Cr√©√©
```typescript
@OnEvent('review.created')
async handleReviewCreated(payload: {
  providerId: string;
  providerType: 'therapist' | 'salon';
  reviewId: string;
}) {
  await this.interactionTrackingService.debitCredits(
    payload.providerId,
    payload.providerType,
    'review_created',
    payload.reviewId
  );
}
```

#### 5. Favori Ajout√©
```typescript
@OnEvent('favorite.added')
async handleFavoriteAdded(payload: {
  providerId: string;
  providerType: 'therapist' | 'salon';
  userId: string;
}) {
  await this.interactionTrackingService.debitCredits(
    payload.providerId,
    payload.providerType,
    'favorite_added',
    payload.userId
  );
}
```

#### 6. R√©servation Annul√©e
```typescript
@OnEvent('booking.cancelled')
async handleBookingCancelled(payload: {
  providerId: string;
  providerType: 'therapist' | 'salon';
  bookingId: string;
  creditsDebited: number; // Cr√©dits d√©bit√©s lors de la confirmation
}) {
  // Remboursement 60% arrondi inf√©rieur
  const refundAmount = Math.floor(payload.creditsDebited * 0.6);
  
  await this.interactionTrackingService.creditRefund(
    payload.providerId,
    payload.providerType,
    refundAmount,
    'refund_cancellation',
    payload.bookingId
  );
}
```

---

## üì± Frontend Mobile - √âcrans

### 1. Dashboard Cr√©dits (`CreditsDashboardScreen`)
**Affichage :**
- Solde actuel (grand, visible)
- Graphique d√©penses 7 derniers jours
- Bouton "Acheter des cr√©dits"
- Bouton "Mon code de parrainage"
- Liste des 5 derni√®res transactions

**Navigation :**
- ‚Üí `PurchaseCreditsScreen`
- ‚Üí `CreditTransactionsScreen` (historique complet)
- ‚Üí `ReferralScreen`
- ‚Üí `CreditStatsScreen`

### 2. Achat de Cr√©dits (`PurchaseCreditsScreen`)
**Affichage :**
- Liste des packs (cartes avec badge "Meilleure offre")
- S√©lection du pack
- Choix m√©thode de paiement (Flutterwave)
- Bouton "Acheter maintenant"

**Flow :**
1. S√©lection pack
2. Confirmation montant
3. Redirection Flutterwave
4. Paiement (Mobile Money / Carte)
5. Callback ‚Üí Cr√©dit du compte
6. Notification succ√®s

### 3. Parrainage (`ReferralScreen`)
**Affichage :**
- Mon code de parrainage (grand, copiable)
- Bouton "Partager le code"
- Statistiques :
  - Filleuls actifs
  - Cr√©dits gagn√©s ce mois
  - Cr√©dits gagn√©s total
- Liste des filleuls avec statut
- Compteur : "X/10 parrainages ce mois"

**Actions :**
- Copier le code
- Partager via WhatsApp, SMS, Email
- Voir d√©tails d'un filleul

### 4. Boost de Position (`BoostPositionScreen`)
**Affichage :**
- Carte interactive avec positions 1-5
- Prix de chaque position
- Indicateur "Ench√®res actives" si > 4 demandes
- Formulaire d'achat/ench√®re
- Mes boosts actifs

**Flow Achat (‚â§ 4 demandes) :**
1. S√©lection position
2. Confirmation prix (cr√©dits)
3. Achat imm√©diat
4. Activation du boost

**Flow Ench√®res (> 4 demandes) :**
1. S√©lection position
2. Saisie montant ench√®re (‚â• prix fixe)
3. Confirmation
4. Attente 24h
5. Notification r√©sultat

### 5. Statistiques Cr√©dits (`CreditStatsScreen`)
**Affichage :**
- Graphiques :
  - D√©penses par type d'interaction (camembert)
  - √âvolution du solde (courbe)
  - Pr√©visions (tendance)
- Tableaux :
  - Top interactions consommatrices
  - Moyenne d√©penses/jour
  - Projection √©puisement cr√©dits

### 6. Historique Transactions (`CreditTransactionsScreen`)
**Affichage :**
- Liste pagin√©e des transactions
- Filtres : type, p√©riode
- D√©tails par transaction :
  - Date/heure
  - Type
  - Montant (+ ou -)
  - Solde apr√®s
  - R√©f√©rence (booking, chat, etc.)

---

## üîç Int√©gration dans l'App Existante

### Modifications N√©cessaires

#### 1. Recherche de Prestataires
**Fichiers :** `SearchResults`, [HomeScreen](file:///Users/apple/Documents/kmerservices/mobile/src/screens/main/HomeScreen.tsx#28-818), `ServicesScreen`

```typescript
// Filtrer providers avec cr√©dits > 0
const visibleProviders = await VisibilityService.filterVisible(allProviders);

// Ordre d'affichage :
// 1. Providers avec boost actif (position 1-5)
// 2. Providers sans boost, tri√©s par rating
const sortedProviders = [
  ...boostedProviders.sort((a, b) => a.boostPosition - b.boostPosition),
  ...regularProviders.sort((a, b) => b.rating - a.rating)
];
```

#### 2. Profil Prestataire
**Fichier :** [ProviderDetailsScreen](file:///Users/apple/Documents/kmerservices/mobile/src/screens/main/ProviderDetailsScreen.tsx#30-579)

```typescript
// Au montage du composant
useEffect(() => {
  // √âmettre √©v√©nement de visite
  eventEmitter.emit('profile.viewed', {
    providerId: provider.id,
    providerType: provider.type,
    userId: currentUser.id
  });
}, [provider.id]);

// Afficher badge si boost actif
{provider.boostPosition && (
  <Badge>Top {provider.boostPosition}</Badge>
)}
```

#### 3. Chat
**Fichier :** `ChatScreen`

```typescript
// Lors de l'envoi du 1er message
const sendFirstMessage = async () => {
  // V√©rifier si pr√©-commande
  const hasConfirmedBooking = await checkConfirmedBooking(
    currentUser.id,
    provider.id
  );
  
  // √âmettre √©v√©nement
  eventEmitter.emit('chat.started', {
    providerId: provider.id,
    providerType: provider.type,
    userId: currentUser.id,
    chatId: chat.id,
    isPreBooking: !hasConfirmedBooking
  });
  
  // Envoyer message
  await sendMessage(messageContent);
};
```

#### 4. R√©servations
**Fichier :** [BookingDetailsScreen](file:///Users/apple/Documents/kmerservices/mobile/src/screens/main/BookingDetailsScreen.tsx#24-559)

```typescript
// Lors de la confirmation
const confirmBooking = async () => {
  // Confirmer la r√©servation
  await bookingsApi.confirm(booking.id);
  
  // √âmettre √©v√©nement
  eventEmitter.emit('booking.confirmed', {
    providerId: booking.providerId,
    providerType: booking.providerType,
    bookingId: booking.id
  });
};

// Lors de l'annulation
const cancelBooking = async () => {
  // R√©cup√©rer cr√©dits d√©bit√©s
  const transaction = await getBookingTransaction(booking.id);
  
  // Annuler
  await bookingsApi.cancel(booking.id);
  
  // √âmettre √©v√©nement
  eventEmitter.emit('booking.cancelled', {
    providerId: booking.providerId,
    providerType: booking.providerType,
    bookingId: booking.id,
    creditsDebited: Math.abs(transaction.amount)
  });
};
```

#### 5. Avis
**Fichier :** [ReviewScreen](file:///Users/apple/Documents/kmerservices/mobile/src/screens/main/ReviewScreen.tsx#27-278)

```typescript
// Apr√®s soumission avis
const submitReview = async () => {
  // Cr√©er l'avis
  const review = await reviewsApi.create(reviewData);
  
  // √âmettre √©v√©nement
  eventEmitter.emit('review.created', {
    providerId: booking.providerId,
    providerType: booking.providerType,
    reviewId: review.id
  });
};
```

#### 6. Favoris
**Fichier :** `FavoritesScreen`, [ProviderDetailsScreen](file:///Users/apple/Documents/kmerservices/mobile/src/screens/main/ProviderDetailsScreen.tsx#30-579)

```typescript
// Lors de l'ajout aux favoris
const addToFavorites = async () => {
  // Ajouter
  await favoritesApi.add(provider.id, provider.type);
  
  // √âmettre √©v√©nement
  eventEmitter.emit('favorite.added', {
    providerId: provider.id,
    providerType: provider.type,
    userId: currentUser.id
  });
};
```

---

## ‚úÖ Checklist de Validation

### Backend
- [ ] Migrations DB cr√©√©es et test√©es
- [ ] Services cr√©dits impl√©ment√©s
- [ ] Event listeners configur√©s
- [ ] Cron jobs programm√©s
- [ ] Int√©gration Flutterwave compl√®te
- [ ] Webhooks Flutterwave s√©curis√©s
- [ ] Syst√®me de parrainage fonctionnel
- [ ] Boost de position (fixe + ench√®res)
- [ ] Tests unitaires (>80% coverage)
- [ ] Tests d'int√©gration

### Frontend
- [ ] Dashboard cr√©dits
- [ ] √âcran achat de cr√©dits
- [ ] Int√©gration Flutterwave SDK
- [ ] √âcran parrainage
- [ ] √âcran boost de position
- [ ] Statistiques et graphiques
- [ ] Notifications push configur√©es
- [ ] Filtrage visibilit√© dans recherche
- [ ] Badges boost affich√©s
- [ ] Tests E2E

### Fonctionnel
- [ ] 20 cr√©dits initiaux attribu√©s
- [ ] +5 cr√©dits mensuels automatiques
- [ ] D√©bit sur chaque interaction
- [ ] Visibilit√© = 0 si cr√©dits = 0
- [ ] Paiement Flutterwave OK
- [ ] Parrainage limit√© √† 10/mois
- [ ] Boost prix fixe/ench√®res selon zone
- [ ] Remboursement 60% arrondi inf√©rieur
- [ ] Notifications < 5 cr√©dits
- [ ] R√©servations en cours prot√©g√©es

---

## üìö Documentation Compl√©mentaire

### Flutterwave Integration
- [Documentation officielle](https://developer.flutterwave.com/docs)
- [React Native SDK](https://github.com/Flutterwave/react-native-flutterwave)
- [Webhook Security](https://developer.flutterwave.com/docs/integration-guides/webhooks)

### Ressources
- Diagrammes de flux (√† cr√©er)
- Postman collection (√† cr√©er)
- Guide d'utilisation prestataires (√† cr√©er)

---

**Document cr√©√© le :** 24 novembre 2025  
**Version :** 1.0  
**Auteur :** √âquipe Technique KmerServices
